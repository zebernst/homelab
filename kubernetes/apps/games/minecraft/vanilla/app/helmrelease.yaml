# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app vanilla
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: app-template
    namespace: flux-system

  values:
    controllers:
      *app:
        type: statefulset
        annotations:
          reloader.stakater.com/auto: "true"
        initContainers:
          init-bluemap-config:
            image:
              repository: busybox
              tag: latest
            command: ["sh", "-c"]
            args:
              - cp /config-source/*.conf /app/config/
        containers:
          *app:
            image:
              repository: ghcr.io/itzg/minecraft-server
              tag: 2026.2.1-java21
            env:
              EULA: "true"
              TZ: America/Chicago
              TYPE: "VANILLA"
              VERSION: "LATEST"
              ICON: https://media.forgecdn.net/avatars/thumbnails/1382/76/64/64/638896474054932351.png
              MOTD: |
                A Minecraft server on %VERSION%.
                §oHosted on §dJupiter§r
              SERVER_NAME: *app
              DIFFICULTY: normal
              ALLOW_FLIGHT: true
              ENFORCE_WHITELIST: "true"
              EXISTING_WHITELIST_FILE: SYNCHRONIZE
              WHITELIST: |
                zebernst
                Snorlocke
                Travler34__
              OPS: |
                zebernst
              PAUSE_WHEN_EMPTY_SECONDS: "60"
              INIT_MEMORY: 1G
              MAX_MEMORY: &max-memory 4G
            envFrom:
              - secretRef:
                  name: vanilla-secret
            probes:
              liveness: &probe
                enabled: true
                custom: true
                spec:
                  periodSeconds: 15
                  exec: &probeexec { command: [ "mc-health" ] }
              readiness: *probe
              startup:
                <<: *probe
                spec:
                  initialDelaySeconds: 10
                  periodSeconds: 1
                  failureThreshold: 60
                  exec: *probeexec
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities: { drop: ["ALL"] }
            resources:
              requests:
                cpu: 1
                memory: *max-memory
          bluemap:
            image:
              repository: ghcr.io/bluemap-minecraft/bluemap
              tag: v5.13
            args: ["-r", "-u", "-w"]
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: false
              capabilities: { drop: ["ALL"] }
            resources:
              requests:
                cpu: 250m
                memory: 512Mi
              limits:
                memory: 1Gi
    defaultPodOptions:
      priorityClassName: best-effort
      securityContext:
        runAsNonRoot: true
        runAsUser: 568
        runAsGroup: 568
        fsGroup: 568
        fsGroupChangePolicy: OnRootMismatch
    service:
      *app:
        annotations:
          mc-router.itzg.me/defaultServer: "true"
          mc-router.itzg.me/autoScaleUp: "true"
          mc-router.itzg.me/autoScaleDown: "true"
        ports:
          game:
            port: 25565
      map:
        controller: *app
        ports:
          http:
            port: 8100
      rcon:
        controller: *app
        type: LoadBalancer
        loadBalancerClass: tailscale
        annotations:
          tailscale.com/hostname: vanilla-rcon
        ports:
          rcon:
            port: 25578
    route:
      map:
        hostnames: ["worldmap.zebernst.dev"]
        parentRefs:
          - name: external
            namespace: kube-system
            sectionName: https
        rules:
          - matches:
              - path:
                  type: Exact
                  value: /vanilla
            filters:
              - type: RequestRedirect
                requestRedirect:
                  path:
                    type: ReplaceFullPath
                    replaceFullPath: /vanilla/
                  statusCode: 301
          - matches:
              - path:
                  type: PathPrefix
                  value: /vanilla/
            filters:
              - type: URLRewrite
                urlRewrite:
                  path:
                    type: ReplacePrefixMatch
                    replacePrefixMatch: /
            backendRefs:
              - name: vanilla-map
                port: 8100
    persistence:
      tmp:
        type: emptyDir
        advancedMounts:
          *app:
            *app:
              - path: /tmp
      data:
        existingClaim: *app
        advancedMounts:
          *app:
            *app:
              - path: /data
            bluemap:
              - path: /app/world
                subPath: world
                readOnly: true
      bluemap-config-source:
        type: configMap
        name: vanilla-bluemap-config
        advancedMounts:
          *app:
            init-bluemap-config:
              - path: /config-source
                readOnly: true
      bluemap-config:
        type: emptyDir
        advancedMounts:
          *app:
            init-bluemap-config:
              - path: /app/config
            bluemap:
              - path: /app/config
      bluemap-cache:
        type: emptyDir
        advancedMounts:
          *app:
            bluemap:
              - path: /app/bluemap
              - path: /app/web
              - path: /app/data
